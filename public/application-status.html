<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>応募状況一覧 - DXPRO SOLUTIONS</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6 font-sans min-h-screen">

  <div class="max-w-6xl mx-auto mt-10">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-gray-800">応募状況一覧</h2>
      <a href="/" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition duration-200">
        ホームに戻る
      </a>
    </div>

    <div class="overflow-x-auto rounded-xl shadow-md bg-white">
      <table id="appTable" class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">日付</th>
            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">応募タイプ</th>
            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">名前</th>
            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">メール</th>
            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">応募ポジション</th>
            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">ステータス</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ポジション表示名
    const positionMap = {
      frontend: "フロントエンド",
      backend: "バックエンド",
      designer: "UIデザイナー",
      pm: "プロジェクトマネージャー",
      consultant: "コンサルタント",
      qaengineer: "QAエンジニア"
    };

    // ステータスバッジ
    function getStatusBadge(status) {
      if (!status) status = "送信済み";
      const base = "py-1 px-3 rounded-full text-sm font-semibold shadow-sm";
      switch(status) {
        case '承認済み':
          return `<span class="bg-green-100 text-green-800 ${base}">${status}</span>`;
        case '進行中':
          return `<span class="bg-yellow-100 text-yellow-800 ${base}">${status}</span>`;
        case '却下':
          return `<span class="bg-red-100 text-red-800 ${base}">${status}</span>`;
        default:
          return `<span class="bg-gray-100 text-gray-800 ${base}">${status}</span>`;
      }
    }

    // 応募一覧ロード
    async function loadApplications() {
      try {
        const res = await fetch("/api/applications");
        const data = await res.json();
        const tbody = document.querySelector("#appTable tbody");
        tbody.innerHTML = "";

        if (data.status === "success" && data.applications.length > 0) {
          data.applications.forEach(app => {
            const tr = document.createElement("tr");
            tr.className = "hover:bg-gray-50 cursor-pointer transition duration-150";

            const displayPosition = positionMap[app.position] || app.position || "";

            tr.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap">${new Date(app.createdAt).toLocaleDateString()}</td>
              <td class="px-6 py-4 whitespace-nowrap">${app.type || "不明"}</td>
              <td class="px-6 py-4 whitespace-nowrap">${app.lastName || ""} ${app.firstName || ""}</td>
              <td class="px-6 py-4 whitespace-nowrap">${app.email || ""}</td>
              <td class="px-6 py-4 whitespace-nowrap">${displayPosition}</td>
              <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(app.status)}</td>
            `;
            tbody.appendChild(tr);

            // 行クリックで詳細画面へ遷移
            tr.addEventListener("click", () => {
              window.location.href = `/application-detail.html?id=${app._id}`;
            });
          });
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="px-6 py-4 text-center text-gray-400">応募履歴がありません</td>
            </tr>
          `;
        }
      } catch (err) {
        console.error(err);
        const tbody = document.querySelector("#appTable tbody");
        tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">読み込み中にエラーが発生しました</td></tr>`;
      }
    }

    loadApplications();
  </script>
</body>
</html>
